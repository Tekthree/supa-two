---
import Layout from '../layouts/Layout.astro';
import galleryData from '../../public/galleryData.js';
import { YouTube } from '@astro-community/astro-embed-youtube';
import PlayerBottom from '../components/PlayerBottom.astro';
import { createClient } from '@supabase/supabase-js';
import { Client, GatewayIntentBits } from 'discord.js'; // Import the Discord library

const client = new Client({
  intents: [
    GatewayIntentBits.Guilds,
    GatewayIntentBits.GuildMessages,
    GatewayIntentBits.MessageContent,
    GatewayIntentBits.GuildMembers,
  ],
}); // Create a new Discord client

const token = import.meta.env.DISCORD_BOT_TOKEN;
const apiKey = import.meta.env.YOUTUBE_API_KEY;

const supabaseAdin = createClient(
  import.meta.env.PUBLIC_SUPABASE_URL,
  import.meta.env.SUPABASE_SERVICE_ROLE_KEY
);

const { data } = await supabaseAdin.from('music').select('*').order('id');

// Replace with the ID of the text channel you want to search
// const channelIds = [
//   '1057747211468943450',
//   '1049841438919245925',
//   '1062329322477727764',
//   '1062325851418525776',
//   '1062325992137424986',
//   '1062327975091126342',
//   '1071400000216641566',
// ];

// client.on('ready', () => {
//   console.log(`Logged in as ${client.user.tag}!`);

//   channelIds.forEach((channelId) => {
//     const channel = client.channels.cache.get(channelId);

//     let allMessages = [];
//     let lastMessageId;
//     const fetchMessages = () => {
//       channel.messages
//         .fetch({ limit: 100, before: lastMessageId })
//         .then((messages) => {
//           allMessages = allMessages.concat(messages);
//           lastMessageId = messages.last().id;
//           if (messages.size === 100) {
//             fetchMessages();
//           } else {
//             const youtubeMessages = messages.filter((message) => {
//               return message.content.includes('youtu');
//             });

//             let youtubeVideos = [];
//             youtubeMessages.forEach(async (message) => {
//               const url = message.content.match(/https?:\/\/[^\s]+/)[0];
//               const channelId = message.channel.id;
//               const username = message.author.username;

//               const urlRegex =
//                 /(?:youtube(?:-nocookie)?\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
//               const videoId = url.match(urlRegex);

//               if (videoId && videoId[1].length === 11) {
//                 const response = await fetch(
//                   `https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics&id=${videoId[1]}&key=${apiKey}`
//                 );
//                 const info = await response.json();

//                 // await supabaseAdin.from('music').insert([
//                 //   {
//                 //     title: info.items[0].snippet.title,
//                 //     url: url,
//                 //     video_id: videoId[1],
//                 //     channel_id: channelId,
//                 //     username: username,
//                 //   },
//                 // ]);

//                 if (info.items[0]) {
//                   youtubeVideos.push({
//                     title: info.items[0].snippet.title,
//                     url,
//                     id: videoId[1],
//                     channelId,
//                     username,
//                   });
//                 } else {
//                   console.error('No video found with the given videoId');
//                 }
//               }
//               console.log(youtubeVideos);
//             });
//           }
//         });
//     };
//     fetchMessages();
//   });
// });

// client.login(token);
---

<Layout title='Okizoo Homepage'>
  <main class='bg-black'>
    <div class='mx-auto max-w-7xl sm:px-6 lg:px-8'>
      <!-- Content goes here -->

      <div class=''>
        <div
          class='mx-auto max-w-2xl py-16 px-4 sm:py-24 sm:px-6 lg:max-w-7xl lg:px-8'
        >
          <div
            id='player'
            class='w-full relative top-2 left-2 border-4 border-[#2b3860] rounded-2xl'
          >
          </div>

          <h2 class='sr-only'>Products</h2>

          <div
            class='pt-20 grid grid-cols-1 gap-y-10 gap-x-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 xl:gap-x-8'
          >
            {
              data.map((card) => (
                <div class='group border border-[#121212] p-4 rounded-2xl '>
                  <div class='aspect-w-1 aspect-h-1 w-full overflow-hidden rounded-lg bg-gray xl:aspect-w-7 xl:aspect-h-8'>
                    <YouTube
                      class='h-full w-full object-cover object-center group-hover:opacity-75'
                      id={card.url}
                    />
                  </div>
                  <h3 class='mt-4 text-lg text-gray-700'>{card.title}</h3>
                  <p class='mt-1 text-sm font-medium text-gray-900'>
                    {card.username}
                  </p>
                </div>
              ))
            }

            <!-- More products... -->
          </div>
        </div>
      </div>
    </div>

    <PlayerBottom />
  </main>
</Layout>
